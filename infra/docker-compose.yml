services:
  server:
    build:
      context: ../server
      dockerfile: Dockerfile
    container_name: autodrive-lab-server
    restart: unless-stopped
    environment:
      - PORT=${PORT:-8000}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MODEL_VERSION=${MODEL_VERSION:-v0}
      - MODEL_RUNTIME=${MODEL_RUNTIME:-rule}
    ports:
      - "${PORT:-8000}:${PORT:-8000}"
    command: >
      uvicorn app:app --host 0.0.0.0 --port ${PORT:-8000}
    healthcheck:
      test: ["CMD", "python", "-c", "import os,urllib.request,urllib.error; p=os.getenv('PORT','8000'); u=f'http://127.0.0.1:{p}/health'; urllib.request.urlopen(u, timeout=2).read()"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

